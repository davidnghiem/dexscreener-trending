{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/nghiem/Desktop/dexscreener/app/api/trending/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\n\n// Supported chains on DexScreener\nconst SUPPORTED_CHAINS = [\n  'solana', 'ethereum', 'bsc', 'base', 'polygon', 'arbitrum', 'avalanche',\n  'optimism', 'ton', 'sui', 'abstract', 'cronos', 'hyperliquid', 'sonic',\n  'fantom', 'linea', 'tron', 'mantle', 'aptos', 'seiv2', 'zksync', 'blast',\n  'moonbeam', 'celo', 'scroll', 'mode', 'manta', 'aurora', 'monad', 'pulsechain'\n];\n\ninterface TokenInfo {\n  chain: string;\n  contract_address: string;\n  token_name: string;\n  token_symbol: string;\n  pair_address: string;\n  price_usd: string | null;\n  market_cap: number | null;\n  liquidity_usd: number | null;\n  age: string | null;\n  age_hours: number | null;\n  dexscreener_url: string;\n}\n\nasync function getTokenInfoFromPair(chain: string, pairAddress: string): Promise<TokenInfo | null> {\n  const apiUrl = `https://api.dexscreener.com/latest/dex/pairs/${chain}/${pairAddress}`;\n  \n  try {\n    const response = await fetch(apiUrl, {\n      headers: {\n        'User-Agent': 'Mozilla/5.0',\n        'Accept': 'application/json',\n      },\n    });\n    \n    if (!response.ok) return null;\n    \n    const data = await response.json();\n    \n    if (data.pairs && data.pairs.length > 0) {\n      const pair = data.pairs[0];\n      const baseToken = pair.baseToken || {};\n      \n      // Calculate age\n      let ageStr: string | null = null;\n      let ageHours: number | null = null;\n      \n      if (pair.pairCreatedAt) {\n        const createdTime = new Date(pair.pairCreatedAt);\n        const now = new Date();\n        const diffMs = now.getTime() - createdTime.getTime();\n        ageHours = diffMs / (1000 * 60 * 60);\n        \n        if (ageHours < 1) {\n          ageStr = `${Math.floor(diffMs / (1000 * 60))}m`;\n        } else if (ageHours < 24) {\n          ageStr = `${Math.floor(ageHours)}h`;\n        } else if (ageHours < 24 * 30) {\n          ageStr = `${Math.floor(ageHours / 24)}d`;\n        } else if (ageHours < 24 * 365) {\n          ageStr = `${Math.floor(ageHours / 24 / 30)}mo`;\n        } else {\n          ageStr = `${Math.floor(ageHours / 24 / 365)}y`;\n        }\n      }\n      \n      return {\n        chain,\n        contract_address: baseToken.address,\n        token_name: baseToken.name || 'Unknown',\n        token_symbol: baseToken.symbol || '???',\n        pair_address: pairAddress,\n        price_usd: pair.priceUsd,\n        market_cap: pair.marketCap,\n        liquidity_usd: pair.liquidity?.usd,\n        age: ageStr,\n        age_hours: ageHours,\n        dexscreener_url: `https://dexscreener.com/${chain}/${pairAddress}`,\n      };\n    }\n  } catch (error) {\n    console.error(`Error fetching pair ${pairAddress}:`, error);\n  }\n  \n  return null;\n}\n\nasync function getTrendingPairsFromHomepage(): Promise<Array<{ chain: string; pairAddress: string }>> {\n  try {\n    const response = await fetch('https://dexscreener.com', {\n      headers: {\n        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n        'Accept': 'text/html',\n      },\n    });\n    \n    if (!response.ok) return [];\n    \n    const html = await response.text();\n    \n    // Build regex pattern for chains\n    const chainsPattern = SUPPORTED_CHAINS.join('|');\n    const linkPattern = new RegExp(`\\\\]\\\\(/(${chainsPattern})/([a-zA-Z0-9x]+)\\\\)`, 'gi');\n    const hrefPattern = new RegExp(`href=\"/(${chainsPattern})/([a-zA-Z0-9x]+)\"`, 'gi');\n    \n    const pairs: Array<{ chain: string; pairAddress: string }> = [];\n    const seen = new Set<string>();\n    \n    // Find matches with both patterns\n    const allMatches = [\n      ...html.matchAll(linkPattern),\n      ...html.matchAll(hrefPattern),\n    ];\n    \n    for (const match of allMatches) {\n      const chain = match[1].toLowerCase();\n      const pairAddress = match[2];\n      const key = `${chain}:${pairAddress.toLowerCase()}`;\n      \n      if (!seen.has(key)) {\n        seen.add(key);\n        pairs.push({ chain, pairAddress });\n      }\n    }\n    \n    return pairs;\n  } catch (error) {\n    console.error('Error fetching homepage:', error);\n    return [];\n  }\n}\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const chain = searchParams.get('chain');\n  const limitParam = searchParams.get('limit');\n  const limit = Math.min(limitParam ? parseInt(limitParam) : 50, 50); // Cap at 50\n  \n  try {\n    // Get trending pairs from homepage\n    let pairs = await getTrendingPairsFromHomepage();\n    \n    // Filter by chain if specified\n    if (chain) {\n      pairs = pairs.filter(p => p.chain === chain.toLowerCase());\n    }\n    \n    // Limit pairs to process (fetch a few extra in case of duplicates)\n    pairs = pairs.slice(0, Math.min(limit + 10, 60));\n    \n    // Resolve token addresses via API (in batches to be faster)\n    const tokens: TokenInfo[] = [];\n    const seenTokens = new Set<string>();\n    \n    // Process in parallel batches of 10\n    const batchSize = 10;\n    for (let i = 0; i < pairs.length; i += batchSize) {\n      const batch = pairs.slice(i, i + batchSize);\n      const results = await Promise.all(\n        batch.map(({ chain, pairAddress }) => getTokenInfoFromPair(chain, pairAddress))\n      );\n      \n      for (const tokenInfo of results) {\n        if (tokenInfo && tokenInfo.contract_address) {\n          const tokenKey = `${tokenInfo.chain}:${tokenInfo.contract_address.toLowerCase()}`;\n          if (!seenTokens.has(tokenKey)) {\n            seenTokens.add(tokenKey);\n            tokens.push(tokenInfo);\n            \n            // Stop if we've reached the limit\n            if (tokens.length >= limit) break;\n          }\n        }\n      }\n      \n      // Stop processing batches if we've reached the limit\n      if (tokens.length >= limit) break;\n      \n      // Small delay between batches\n      if (i + batchSize < pairs.length) {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      }\n    }\n    \n    return NextResponse.json({\n      timestamp: new Date().toISOString(),\n      total: tokens.length,\n      tokens,\n    });\n  } catch (error) {\n    console.error('Error:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch trending tokens' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,kCAAkC;AAClC,MAAM,mBAAmB;IACvB;IAAU;IAAY;IAAO;IAAQ;IAAW;IAAY;IAC5D;IAAY;IAAO;IAAO;IAAY;IAAU;IAAe;IAC/D;IAAU;IAAS;IAAQ;IAAU;IAAS;IAAS;IAAU;IACjE;IAAY;IAAQ;IAAU;IAAQ;IAAS;IAAU;IAAS;CACnE;AAgBD,eAAe,qBAAqB,KAAa,EAAE,WAAmB;IACpE,MAAM,SAAS,CAAC,6CAA6C,EAAE,MAAM,CAAC,EAAE,aAAa;IAErF,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,QAAQ;YACnC,SAAS;gBACP,cAAc;gBACd,UAAU;YACZ;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE,OAAO;QAEzB,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,IAAI,KAAK,KAAK,IAAI,KAAK,KAAK,CAAC,MAAM,GAAG,GAAG;YACvC,MAAM,OAAO,KAAK,KAAK,CAAC,EAAE;YAC1B,MAAM,YAAY,KAAK,SAAS,IAAI,CAAC;YAErC,gBAAgB;YAChB,IAAI,SAAwB;YAC5B,IAAI,WAA0B;YAE9B,IAAI,KAAK,aAAa,EAAE;gBACtB,MAAM,cAAc,IAAI,KAAK,KAAK,aAAa;gBAC/C,MAAM,MAAM,IAAI;gBAChB,MAAM,SAAS,IAAI,OAAO,KAAK,YAAY,OAAO;gBAClD,WAAW,SAAS,CAAC,OAAO,KAAK,EAAE;gBAEnC,IAAI,WAAW,GAAG;oBAChB,SAAS,GAAG,KAAK,KAAK,CAAC,SAAS,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;gBACjD,OAAO,IAAI,WAAW,IAAI;oBACxB,SAAS,GAAG,KAAK,KAAK,CAAC,UAAU,CAAC,CAAC;gBACrC,OAAO,IAAI,WAAW,KAAK,IAAI;oBAC7B,SAAS,GAAG,KAAK,KAAK,CAAC,WAAW,IAAI,CAAC,CAAC;gBAC1C,OAAO,IAAI,WAAW,KAAK,KAAK;oBAC9B,SAAS,GAAG,KAAK,KAAK,CAAC,WAAW,KAAK,IAAI,EAAE,CAAC;gBAChD,OAAO;oBACL,SAAS,GAAG,KAAK,KAAK,CAAC,WAAW,KAAK,KAAK,CAAC,CAAC;gBAChD;YACF;YAEA,OAAO;gBACL;gBACA,kBAAkB,UAAU,OAAO;gBACnC,YAAY,UAAU,IAAI,IAAI;gBAC9B,cAAc,UAAU,MAAM,IAAI;gBAClC,cAAc;gBACd,WAAW,KAAK,QAAQ;gBACxB,YAAY,KAAK,SAAS;gBAC1B,eAAe,KAAK,SAAS,EAAE;gBAC/B,KAAK;gBACL,WAAW;gBACX,iBAAiB,CAAC,wBAAwB,EAAE,MAAM,CAAC,EAAE,aAAa;YACpE;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,CAAC,oBAAoB,EAAE,YAAY,CAAC,CAAC,EAAE;IACvD;IAEA,OAAO;AACT;AAEA,eAAe;IACb,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,2BAA2B;YACtD,SAAS;gBACP,cAAc;gBACd,UAAU;YACZ;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE,OAAO,EAAE;QAE3B,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,iCAAiC;QACjC,MAAM,gBAAgB,iBAAiB,IAAI,CAAC;QAC5C,MAAM,cAAc,IAAI,OAAO,CAAC,QAAQ,EAAE,cAAc,oBAAoB,CAAC,EAAE;QAC/E,MAAM,cAAc,IAAI,OAAO,CAAC,QAAQ,EAAE,cAAc,kBAAkB,CAAC,EAAE;QAE7E,MAAM,QAAuD,EAAE;QAC/D,MAAM,OAAO,IAAI;QAEjB,kCAAkC;QAClC,MAAM,aAAa;eACd,KAAK,QAAQ,CAAC;eACd,KAAK,QAAQ,CAAC;SAClB;QAED,KAAK,MAAM,SAAS,WAAY;YAC9B,MAAM,QAAQ,KAAK,CAAC,EAAE,CAAC,WAAW;YAClC,MAAM,cAAc,KAAK,CAAC,EAAE;YAC5B,MAAM,MAAM,GAAG,MAAM,CAAC,EAAE,YAAY,WAAW,IAAI;YAEnD,IAAI,CAAC,KAAK,GAAG,CAAC,MAAM;gBAClB,KAAK,GAAG,CAAC;gBACT,MAAM,IAAI,CAAC;oBAAE;oBAAO;gBAAY;YAClC;QACF;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,EAAE;IACX;AACF;AAEO,eAAe,IAAI,OAAgB;IACxC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,QAAQ,aAAa,GAAG,CAAC;IAC/B,MAAM,aAAa,aAAa,GAAG,CAAC;IACpC,MAAM,QAAQ,KAAK,GAAG,CAAC,aAAa,SAAS,cAAc,IAAI,KAAK,YAAY;IAEhF,IAAI;QACF,mCAAmC;QACnC,IAAI,QAAQ,MAAM;QAElB,+BAA+B;QAC/B,IAAI,OAAO;YACT,QAAQ,MAAM,MAAM,CAAC,CAAA,IAAK,EAAE,KAAK,KAAK,MAAM,WAAW;QACzD;QAEA,mEAAmE;QACnE,QAAQ,MAAM,KAAK,CAAC,GAAG,KAAK,GAAG,CAAC,QAAQ,IAAI;QAE5C,4DAA4D;QAC5D,MAAM,SAAsB,EAAE;QAC9B,MAAM,aAAa,IAAI;QAEvB,oCAAoC;QACpC,MAAM,YAAY;QAClB,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,MAAM,EAAE,KAAK,UAAW;YAChD,MAAM,QAAQ,MAAM,KAAK,CAAC,GAAG,IAAI;YACjC,MAAM,UAAU,MAAM,QAAQ,GAAG,CAC/B,MAAM,GAAG,CAAC,CAAC,EAAE,KAAK,EAAE,WAAW,EAAE,GAAK,qBAAqB,OAAO;YAGpE,KAAK,MAAM,aAAa,QAAS;gBAC/B,IAAI,aAAa,UAAU,gBAAgB,EAAE;oBAC3C,MAAM,WAAW,GAAG,UAAU,KAAK,CAAC,CAAC,EAAE,UAAU,gBAAgB,CAAC,WAAW,IAAI;oBACjF,IAAI,CAAC,WAAW,GAAG,CAAC,WAAW;wBAC7B,WAAW,GAAG,CAAC;wBACf,OAAO,IAAI,CAAC;wBAEZ,kCAAkC;wBAClC,IAAI,OAAO,MAAM,IAAI,OAAO;oBAC9B;gBACF;YACF;YAEA,qDAAqD;YACrD,IAAI,OAAO,MAAM,IAAI,OAAO;YAE5B,8BAA8B;YAC9B,IAAI,IAAI,YAAY,MAAM,MAAM,EAAE;gBAChC,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;YACnD;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,WAAW,IAAI,OAAO,WAAW;YACjC,OAAO,OAAO,MAAM;YACpB;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,UAAU;QACxB,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAkC,GAC3C;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}